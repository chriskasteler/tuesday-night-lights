<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Captain Account Setup - Braemar Highland League</title>
    
    <!-- Open Graph meta tags for sharing -->
    <meta property="og:title" content="Captain Account Setup - Braemar Highland League" />
    <meta property="og:description" content="Create your captain account to manage your team in Tuesday Night Lights 2025!" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://tuesdaynightlights.com" />
    <meta property="og:site_name" content="Braemar Highland League" />
    
    <link rel="stylesheet" href="styles.css">
    
    <!-- Override styles for captain signup page -->
    <style>
        .content-section {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        .info-section {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        .main-content {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
    </style>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="db-config.js"></script>
</head>
<body>
    <!-- Loading overlay -->
    <div id="page-loading-overlay" class="page-loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>Loading...</p>
        </div>
    </div>

    <div class="container">
        <div class="hero">
            <img src="logo.png" alt="Braemar Highland League" class="logo">
            <p class="subtitle"><em>"Tuesday Night Lights"</em></p>
        </div>

        <div class="main-content">
            <div class="content-section">
                <div class="info-section" style="max-width: 500px; margin: 40px auto;">
                    <h2 style="text-align: center; margin-bottom: 30px; color: #2d4a2d;">Captain Account Setup</h2>
                    
                    <div class="highlight" style="margin-bottom: 30px;">
                        <h3 style="margin-bottom: 10px;">Welcome, Captain!</h3>
                        <p>You've been selected as a team captain for Tuesday Night Lights 2025. Create your account below to access your captain's tools and manage your team.</p>
                    </div>

                    <form id="captain-signup-form" style="background: #f8f9f8; padding: 30px; border-radius: 8px; border: 1px solid #ddd;">
                        <div style="margin-bottom: 20px;">
                            <label for="email" style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d4a2d;">Email Address:</label>
                            <input type="email" id="email" name="email" required readonly
                                   style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; background: #f0f0f0; color: #666; font-size: 1rem;">
                            <small style="color: #666; margin-top: 5px; display: block;">This email was pre-filled based on your captain invitation.</small>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label for="password" style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d4a2d;">Create Password:</label>
                            <input type="password" id="password" name="password" required minlength="6"
                                   style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                            <small style="color: #666; margin-top: 5px; display: block;">Password must be at least 6 characters long.</small>
                        </div>

                        <div style="margin-bottom: 25px;">
                            <label for="confirm-password" style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d4a2d;">Confirm Password:</label>
                            <input type="password" id="confirm-password" name="confirm-password" required minlength="6"
                                   style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                        </div>

                        <button type="submit" id="create-account-btn"
                                style="width: 100%; background: #2d4a2d; color: white; border: none; padding: 15px; border-radius: 4px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: background 0.3s ease;">
                            Create Captain Account
                        </button>
                    </form>

                    <div id="status-message" style="margin-top: 20px; padding: 15px; border-radius: 4px; display: none;"></div>

                    <div style="text-align: center; margin-top: 30px;">
                        <p style="color: #666; font-size: 0.9rem;">Already have an account? <a href="/" style="color: #2d4a2d; text-decoration: none; font-weight: 600;">Return to main site</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY",
            authDomain: "highland-league.firebaseapp.com",
            projectId: "highland-league",
            storageBucket: "highland-league.firebasestorage.app",
            messagingSenderId: "524421750763",
            appId: "1:524421750763:web:f13044cd6318ca1fe943ae"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Extract email from URL parameters and pre-fill
        document.addEventListener('DOMContentLoaded', function() {
            hideLoadingOverlay();
            
            const urlParams = new URLSearchParams(window.location.search);
            const email = urlParams.get('email');
            
            if (email) {
                document.getElementById('email').value = decodeURIComponent(email);
            } else {
                // For testing purposes, show a placeholder message instead of hiding the form
                document.getElementById('email').value = 'your-email@example.com';
                document.getElementById('email').style.background = '#fff3cd';
                showStatusMessage('This is a preview. Captain emails will be pre-filled automatically.', 'info');
            }
        });

        // Handle form submission
        document.getElementById('captain-signup-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            // Validate passwords match
            if (password !== confirmPassword) {
                showStatusMessage('Passwords do not match. Please try again.', 'error');
                return;
            }
            
            // Validate email is in participants as a captain
            try {
                showLoadingState(true);
                
                // Check if this email belongs to a captain in our system
                const participantsSnapshot = await dbHelper.collection('participants').where('email', '==', email).get();
                
                if (participantsSnapshot.empty) {
                    showStatusMessage('Email not found in our system. Please contact an administrator.', 'error');
                    showLoadingState(false);
                    return;
                }
                
                const participant = participantsSnapshot.docs[0].data();
                if (!participant.teamCaptain) {
                    showStatusMessage('This email is not registered as a team captain. Please contact an administrator.', 'error');
                    showLoadingState(false);
                    return;
                }
                
                // Create Firebase user account
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Add user to users collection with captain role
                await db.collection('users').doc(user.uid).set({
                    email: email,
                    role: 'captain',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Success!
                showStatusMessage('Account created successfully! Redirecting...', 'success');
                
                // Redirect to main site after 2 seconds
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
                
            } catch (error) {
                console.error('Error creating captain account:', error);
                let errorMessage = 'Error creating account. Please try again.';
                
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'An account with this email already exists. Please sign in on the main site instead.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Password is too weak. Please choose a stronger password.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address format.';
                }
                
                showStatusMessage(errorMessage, 'error');
                showLoadingState(false);
            }
        });

        // Show status message
        function showStatusMessage(message, type) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            if (type === 'success') {
                statusDiv.style.background = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.style.border = '1px solid #c3e6cb';
            } else if (type === 'info') {
                statusDiv.style.background = '#d1ecf1';
                statusDiv.style.color = '#0c5460';
                statusDiv.style.border = '1px solid #bee5eb';
            } else {
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.style.border = '1px solid #f5c6cb';
            }
        }

        // Show/hide loading state
        function showLoadingState(loading) {
            const button = document.getElementById('create-account-btn');
            if (loading) {
                button.textContent = 'Creating Account...';
                button.disabled = true;
                button.style.background = '#666';
            } else {
                button.textContent = 'Create Captain Account';
                button.disabled = false;
                button.style.background = '#2d4a2d';
            }
        }

        // Hide loading overlay
        function hideLoadingOverlay() {
            const overlay = document.getElementById('page-loading-overlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        // Button hover effects
        document.addEventListener('DOMContentLoaded', function() {
            const button = document.getElementById('create-account-btn');
            
            button.addEventListener('mouseenter', function() {
                if (!this.disabled) {
                    this.style.background = '#1e3a1e';
                }
            });
            
            button.addEventListener('mouseleave', function() {
                if (!this.disabled) {
                    this.style.background = '#2d4a2d';
                }
            });
        });
    </script>
</body>
</html> 